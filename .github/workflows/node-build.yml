name: Build Node.js Android ARM32

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Install deps
      run: |
        sudo apt update
        sudo apt install -y python3 g++ make ninja-build unzip pkg-config git wget

    - name: Clone Node.js source
      run: |
        git clone https://github.com/nodejs/node.git
        cd node
        git checkout v20.12.2

    - name: Download Android NDK
      run: |
        wget https://dl.google.com/android/repository/android-ndk-r26d-linux.zip
        unzip android-ndk-r26d-linux.zip
        mv android-ndk-r26d ndk

    - name: Set NDK Toolchain & GYP Vars
      run: |
        export TOOLCHAIN=$PWD/ndk/toolchains/llvm/prebuilt/linux-x86_64
        echo "TOOLCHAIN=$TOOLCHAIN" >> $GITHUB_ENV
        
        echo "AR=$TOOLCHAIN/bin/llvm-ar" >> $GITHUB_ENV
        echo "CC=$TOOLCHAIN/bin/armv7a-linux-androideabi21-clang" >> $GITHUB_ENV
        echo "CXX=$TOOLCHAIN/bin/armv7a-linux-androideabi21-clang++" >> $GITHUB_ENV
        
        # V8/GYP required variables
        export host_os=linux
        export target_arch=arm
        export ANDROID_NDK_ROOT=$PWD/ndk
        export GYP_DEFINES="host_os=linux target_arch=arm android_ndk_path=$PWD/ndk"

    - name: Configure Node.js
      run: |
        cd node
        # Export variables in this step so configure sees them
        export host_os=linux
        export target_arch=arm
        export ANDROID_NDK_ROOT=$PWD/../ndk
        export GYP_DEFINES="host_os=linux target_arch=arm android_ndk_path=$PWD/../ndk"

        ./configure \
          --dest-cpu=arm \
          --dest-os=android \
          --cross-compiling \
          --openssl-no-asm \
          --without-intl \
          --without-cares \
          --prefix=/output

    - name: Build Node.js
      run: |
        cd node
        make -j4

    - name: Package result
      run: |
        mkdir -p out
        cp node/out/Release/node out/node-android-arm32
        tar -czf node-android-arm32.tar.gz -C out .

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: node-android-arm32
        path: node-android-arm32.tar.gz