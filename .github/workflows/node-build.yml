name: Build Node.js Android ARM32

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y python3 g++ make ninja-build unzip pkg-config git wget curl

    - name: Clone Node.js source
      run: |
        git clone https://github.com/nodejs/node.git
        cd node
        git checkout v24.9.0

    - name: Download Android NDK
      run: |
        wget https://dl.google.com/android/repository/android-ndk-r26d-linux.zip
        unzip android-ndk-r26d-linux.zip
        mv android-ndk-r26d ndk

    - name: Set NDK Toolchain & GYP Variables
      run: |
        export TOOLCHAIN=$PWD/ndk/toolchains/llvm/prebuilt/linux-x86_64
        echo "TOOLCHAIN=$TOOLCHAIN" >> $GITHUB_ENV

        echo "AR=$TOOLCHAIN/bin/llvm-ar" >> $GITHUB_ENV
        echo "CC=$TOOLCHAIN/bin/armv7a-linux-androideabi21-clang" >> $GITHUB_ENV
        echo "CXX=$TOOLCHAIN/bin/armv7a-linux-androideabi21-clang++" >> $GITHUB_ENV

        # Required environment variables for V8/GYP
        export host_os=linux
        export target_arch=arm
        export ANDROID_NDK_ROOT=$PWD/ndk
        export GYP_DEFINES="host_os=linux target_arch=arm node_no_cares=1 android_ndk_path=$PWD/ndk"

    - name: Configure Node.js
      run: |
        cd node
        export host_os=linux
        export target_arch=arm
        export ANDROID_NDK_ROOT=$PWD/../ndk
        export GYP_DEFINES="host_os=linux target_arch=arm node_no_cares=1 android_ndk_path=$PWD/../ndk"

        ./configure \
          --dest-cpu=arm \
          --dest-os=android \
          --cross-compiling \
          --openssl-no-asm \
          --without-intl \
          --shared-cares \
          --shared-openssl \
          --shared-sqlite \
          --shared-zlib \
          --with-intl=system-icu \
          --ninja

    - name: Build Node.js
      run: |
        cd node
        ninja -C out/Release node

    - name: Package result
      run: |
        mkdir -p out
        cp node/out/Release/node out/node-android-arm32
        tar -czf node-android-arm32.tar.gz -C out .

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: node-android-arm32
        path: node-android-arm32.tar.gz

    - name: Commit & Push build artifact to main
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git checkout main
        mkdir -p build
        mv node-android-arm32.tar.gz build/
        git add build/node-android-arm32.tar.gz
        git commit -m "Add Android ARM32 Node.js build artifact"
        git push origin main
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}